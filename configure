#!/bin/bash

case $(sed --help 2>&1) in
  *GNU*) sed_i () { sed -i "$@"; };;
  *) sed_i () { sed -i '' "$@"; };;
esac

name_of_current_dir() {
  echo ${PWD##*/}
}

is_dir_writeable() {
  local dir=$1
  local random_file=$dir/test_is_dir_writeable-oMbzDJ8Ueaxcwi864BM5
  touch "$random_file" 2>/dev/null && rm "$random_file" 2>/dev/null
}

can_exec() {
  local command=$(echo $1 | awk '{print $1;}')
  hash $command 2>/dev/null
}

confirm() {
  local message=$1

  echo -n "$message [Y/n] "
  read response
  case $response in
    [yY][eE][sS]|[yY]|"")
      true
      ;;
    *)
      false
      ;;
  esac
}


does_git_exist() {
  [[ -d ".git" ]]
}

is_kit_git() {
  does_git_exist && git remote -v | grep "reo7sp/reo-web-starter-kit" > /dev/null 2>&1
}

reinit_git() {
  rm -rf .git
  git init
}

install_deps() {
  if ! can_exec gulp; then
    if is_dir_writeable /usr/local/bin; then
      npm install --global gulp-cli
    else
      if confirm "Do you want to install gulp?"; then
        echo ">sudo npm install --global gulp-cli"
        sudo npm install --global gulp-cli
      fi
    fi
  fi
  npm install
}

change_info() {
  sed_i -e "s/\"name\": \"reo-web-starter-kit\"/\"name\": \"$(name_of_current_dir)\"/" package.json
  sed_i -e "s/\"description\": \"Boilerplate for sites\"/\"description\": \"\"/" package.json
  sed_i -e "s/\"author\": \"Oleg Morozenkov\"/\"author\": \"$(whoami)\"/" package.json
  rm LICENSE README.md configure
}


main() {
  is_kit_git && reinit_git
  install_deps
  change_info
}

[[ "$0" == "$BASH_SOURCE" ]] && main $@
